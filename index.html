<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Умная система удалённого мониторинга артериального давления</title>

<style>
:root{
  --bg1:#f2fbf6;
  --bg2:#eaf5ef;
  --card:#ffffff;
  --text:#123328;
  --muted:#4f6f62;
  --line:#cfe3d8;

  --btn:#3a8f6a;
  --btn2:#2f7c5c;

  --okBg:#e9fff2;
  --okLine:#7dd3a7;

  --hiBg:#ffe9de;
  --hiLine:#ffb38a;

  --lowBg:#e8f3ff;
  --lowLine:#89bfff;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  color:var(--text);
}
.wrap{max-width:1200px;margin:0 auto;padding:20px}

header{display:flex;justify-content:space-between;gap:20px;flex-wrap:wrap}
h1{margin:0;font-size:24px}
.subtitle{color:var(--muted);font-size:14px;max-width:900px}

.org{font-size:13px;color:var(--muted);margin-top:4px}

.toolbar{display:flex;gap:10px;flex-wrap:wrap}
.btn{
  background:var(--btn);
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:14px;
  font-weight:700;
  cursor:pointer;
}
.btn.secondary{
  background:transparent;
  color:var(--text);
  border:1px solid var(--line);
}
.btn.active{background:var(--btn2)}

.grid{display:grid;grid-template-columns:1.3fr .7fr;gap:14px;margin-top:14px}
body.mode-patient .grid{grid-template-columns:1fr}
body.mode-patient #doctorAside{display:none}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:20px;
  padding:16px;
  box-shadow:0 12px 28px rgba(0,0,0,.08)
}

.note{
  font-size:13px;
  color:var(--muted);
  margin-top:10px;
}

/* таблица */
.tableWrap{overflow-x:auto}
table{
  min-width:1000px;
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid var(--line);
  padding:8px;
  text-align:center;
  font-size:13px;
}
th{background:#e2f1ea}

input{
  width:100%;
  padding:8px;
  border-radius:10px;
  border:1px solid var(--line);
  text-align:center;
  font-variant-numeric:tabular-nums;
}

.field-ok input{background:var(--okBg);border-color:var(--okLine)}
.field-hi input{background:var(--hiBg);border-color:var(--hiLine)}
.field-low input{background:var(--lowBg);border-color:var(--lowLine)}

.kpi{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-top:10px;
}
.kpi .mini{
  background:#fff;
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
}
.val{
  font-size:18px;
  font-weight:800;
}

canvas{width:100%;height:260px}

.footer{
  margin-top:20px;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body class="mode-doctor">
<div class="wrap">

<header>
  <div>
    <h1>Умная система удалённого мониторинга артериального давления</h1>
    <div class="subtitle">
      Для пациента и врача: дневник самоконтроля и аналитическая сводка за период наблюдения
    </div>
    <div class="org">БУ «Югорская городская больница»</div>
  </div>

  <div class="toolbar">
    <button class="btn active" id="modeDoctor">Врач</button>
    <button class="btn" id="modePatient">Пациент</button>
  </div>
</header>

<div class="grid">
  <!-- ЛЕВАЯ КОЛОНКА: ДНЕВНИК ПАЦИЕНТА -->
<section class="card">
  <h2>Дневник артериального давления (30 дней)</h2>
  <p class="subtitle" style="margin-top:6px;">
    Заполняйте утром и вечером. Формат АД: <span class="mono">120/80</span>.
    Низкие значения (САД &lt; 90 или ДАД &lt; 60) подсвечиваются холодно-голубым.
    Превышение порога (≥140/90) — персиковым. Для пульса: &lt;50 и &gt;100 — мягкая подсветка.
  </p>

  <div class="toolbar" style="margin-top:10px;">
    <button class="btn secondary" id="toggleDiary" type="button">Показать дневник</button>

    <a class="btn secondary" href="assets/bp-diary-30days_ru.pdf" download style="text-decoration:none;">
      Скачать PDF (шаблон)
    </a>
    <a class="btn secondary" href="assets/bp-diary-30days.xlsx" download style="text-decoration:none;">
      Скачать XLSX (шаблон)
    </a>

    <button class="btn" id="exportCsv" type="button">Скачать заполненный дневник (CSV)</button>
  </div>

  <div id="diary" hidden style="margin-top:12px;">
    <div class="note">
      Данные сохраняются локально в браузере пользователя. Передача на сервер не выполняется.
    </div>

    <div class="tableWrap" style="margin-top:10px;">
      <table id="bpDiaryTable">
        <thead>
          <tr>
            <th style="width:60px;">День</th>
            <th style="width:160px;">Дата</th>
            <th style="width:160px;">Утро АД</th>
            <th style="width:120px;">Пульс</th>
            <th style="width:160px;">Вечер АД</th>
            <th style="width:120px;">Пульс</th>
            <th style="min-width:240px;">Комментарий</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="toolbar" style="margin-top:10px;">
      <button class="btn secondary" id="btnRecalcPatient" type="button">Пересчитать сводку</button>
      <span class="badge">Подсветка — только мягкие ориентиры, без диагнозов</span>
    </div>

    <div class="kpi" style="margin-top:10px;">
      <div class="mini">
        <div class="val" id="p_avg_m">—</div>
        <div class="note">Среднее утро (САД/ДАД)</div>
        <div class="note" id="p_avg_m_note"></div>
      </div>
      <div class="mini">
        <div class="val" id="p_avg_e">—</div>
        <div class="note">Среднее вечер (САД/ДАД)</div>
        <div class="note" id="p_avg_e_note"></div>
      </div>
      <div class="mini">
        <div class="val" id="p_events">—</div>
        <div class="note">Эпизоды: низкое / ≥140/90</div>
        <div class="note" id="p_pulse_events"></div>
      </div>
    </div>

    <div class="note" style="margin-top:10px;">
      Рекомендация по использованию: пациент выгружает CSV и передаёт врачу. Врач загружает файл и получает сводку за период наблюдения.
    </div>
  </div>
</section>
<!-- ПРАВАЯ КОЛОНКА: ИНСТРУМЕНТЫ ВРАЧА -->
<aside class="card" id="doctorAside">
  <h2>Инструменты врача</h2>
  <p class="subtitle" style="margin-top:6px;">
    Загрузите CSV, полученный от пациента. Сводка рассчитывается автоматически. Формулировки — только ориентиры, без диагнозов.
  </p>

  <div class="toolbar" style="margin-top:10px;">
    <input id="csvFile" type="file" accept=".csv,text/csv" style="max-width:320px;">
    <button class="btn secondary" id="btnClearImport" type="button">Очистить</button>
  </div>

  <div class="note" style="margin-top:8px;">
    Ожидаемый формат: CSV из этого же дневника (разделитель «;»). Колонки: «Дата», «Утро АД», «Утро пульс», «Вечер АД», «Вечер пульс».
  </div>

  <div class="kpi" style="margin-top:12px;">
    <div class="mini">
      <div class="val" id="d_avg_all">—</div>
      <div class="note">Среднее АД за период (все измерения)</div>
      <div class="note" id="d_avg_all_note"></div>
    </div>

    <div class="mini">
      <div class="val" id="d_avg_me">—</div>
      <div class="note">Среднее утро / вечер</div>
      <div class="note" id="d_avg_me_note"></div>
    </div>

    <div class="mini">
      <div class="val" id="d_period">—</div>
      <div class="note">Период наблюдения</div>
      <div class="note" id="d_counts">—</div>
    </div>
  </div>

  <div class="kpi" style="margin-top:10px;">
    <div class="mini">
      <div class="val" id="d_minmax">—</div>
      <div class="note">Минимум / максимум АД</div>
    </div>

    <div class="mini">
      <div class="val" id="d_median">—</div>
      <div class="note">Медианное АД</div>
    </div>

    <div class="mini">
      <div class="val" id="d_range">—</div>
      <div class="note">Разброс значений (макс − мин)</div>
    </div>
  </div>

  <div class="kpi" style="margin-top:10px;">
    <div class="mini">
      <div class="val" id="d_percent_high">—</div>
      <div class="note">Процент превышений ≥140/90</div>
    </div>

    <div class="mini">
      <div class="val" id="d_soft_flags">—</div>
      <div class="note">Ориентиры (низкое АД / пульс)</div>
    </div>

    <div class="mini">
      <button class="btn secondary" id="toggleChart" type="button" style="width:100%;">Показать график</button>
      <div class="note" style="margin-top:8px;">График строится по данным из CSV. Без внешних библиотек.</div>
    </div>
  </div>

  <div id="chartBlock" hidden style="margin-top:12px;">
    <canvas id="bpChart" width="900" height="320" style="border:1px solid var(--line);border-radius:14px;"></canvas>

    <div class="toolbar" style="margin-top:10px;">
      <button class="btn secondary" id="chartAll" type="button">Все измерения</button>
      <button class="btn secondary" id="chartMorning" type="button">Только утро</button>
      <button class="btn secondary" id="chartEvening" type="button">Только вечер</button>
    </div>

    <div class="note" style="margin-top:8px;">
      На графике отображаются САД и ДАД во времени. Горизонтальные линии — ориентиры 140/90.
    </div>
  </div>

  <div class="note" id="doctorWarn" style="margin-top:12px; display:none; padding:10px 12px; border:1px solid var(--line); border-radius:14px; background:#fff;">
  </div>
</aside>
</div> <!-- конец grid -->

<div class="footer">
  Разработано для использования в БУ «Югорская городская больница».<br>
  Инструмент предназначен для поддержки клинического решения и не заменяет врачебную оценку.
</div>

</div> <!-- конец wrap -->

<script>
/* =========================
   ОБЩИЕ УТИЛИТЫ
========================= */

const DAYS = 30;
const LS_KEY = "bp_diary_v2";

function normalizeBP(value){
  const raw = String(value || "").trim();

  if (raw.includes("/")) {
    const [a,b] = raw.split("/",2);
    const sys = (a||"").replace(/\D/g,"").slice(0,3);
    const dia = (b||"").replace(/\D/g,"").slice(0,3);
    if (!sys && !dia) return "";
    if (!dia) return sys + "/";
    return sys + "/" + dia;
  }

  const d = raw.replace(/\D/g,"");
  const n = d.length;
  if (n <= 2) return d;
  if (n === 3) return d;
  if (n === 4) return d.slice(0,2)+"/"+d.slice(2,4);

  if (n === 5) {
    const s3 = Number(d.slice(0,3));
    if (s3 >= 100) return d.slice(0,3)+"/"+d.slice(3,5);
    return d.slice(0,2)+"/"+d.slice(2,5);
  }
  return d.slice(0,3)+"/"+d.slice(3,6);
}

function parseBP(bp){
  const m = String(bp||"").match(/^(\d{2,3})\/(\d{2,3})$/);
  if (!m) return null;
  return { sys:+m[1], dia:+m[2] };
}

function bpState(bp){
  const v = parseBP(bp);
  if (!v) return null;
  if (v.sys < 90 || v.dia < 60) return "low";
  if (v.sys >= 140 || v.dia >= 90) return "high";
  return "ok";
}

function pulseState(v){
  const p = Number(v);
  if (!Number.isFinite(p)) return null;
  if (p < 50) return "low";
  if (p > 100) return "high";
  return "ok";
}

function median(arr){
  if (!arr.length) return null;
  const a = [...arr].sort((a,b)=>a-b);
  const m = Math.floor(a.length/2);
  return a.length%2 ? a[m] : (a[m-1]+a[m])/2;
}

/* =========================
   РЕЖИМЫ
========================= */
const btnDoc = document.getElementById("modeDoctor");
const btnPat = document.getElementById("modePatient");
btnDoc.onclick = ()=>document.body.className="mode-doctor";
btnPat.onclick = ()=>document.body.className="mode-patient";

/* =========================
   ДНЕВНИК ПАЦИЕНТА
========================= */

const tbody = document.querySelector("#bpDiaryTable tbody");
const diaryWrap = document.getElementById("diary");
document.getElementById("toggleDiary").onclick = ()=>{
  diaryWrap.hidden = !diaryWrap.hidden;
  if (!diaryWrap.hidden && !tbody.children.length) buildDiary();
};

function loadDiary(){
  try{return JSON.parse(localStorage.getItem(LS_KEY)||"[]")}catch{return[]}
}
function saveDiary(d){ localStorage.setItem(LS_KEY,JSON.stringify(d)) }

function buildDiary(){
  const data = loadDiary();
  while (data.length < DAYS) {
    data.push({date:"",mbp:"",mhr:"",ebp:"",ehr:"",note:""});
  }
  tbody.innerHTML="";
  data.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input type="date" data-k="date" value="${r.date}"></td>
      <td class="bp"><input data-k="mbp" value="${r.mbp}" inputmode="numeric"></td>
      <td class="pulse"><input data-k="mhr" value="${r.mhr}" inputmode="numeric"></td>
      <td class="bp"><input data-k="ebp" value="${r.ebp}" inputmode="numeric"></td>
      <td class="pulse"><input data-k="ehr" value="${r.ehr}" inputmode="numeric"></td>
      <td><input data-k="note" value="${r.note}"></td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("input").forEach(inp=>{
    inp.oninput = ()=>{
      if (inp.parentElement.classList.contains("bp"))
        inp.value = normalizeBP(inp.value);
      applyRowStyles(inp.closest("tr"));
      saveDiary(readDiary());
      calcPatientStats();
    };
  });

  saveDiary(data);
  calcPatientStats();
}

function readDiary(){
  return [...tbody.querySelectorAll("tr")].map(tr=>{
    const o={};
    tr.querySelectorAll("input").forEach(i=>o[i.dataset.k]=i.value.trim());
    return o;
  });
}

function applyRowStyles(tr){
  tr.querySelectorAll(".bp").forEach(td=>{
    td.classList.remove("field-low","field-hi","field-ok");
    const st = bpState(td.querySelector("input").value);
    if (st) td.classList.add("field-"+st);
  });
  tr.querySelectorAll(".pulse").forEach(td=>{
    td.classList.remove("field-low","field-hi","field-ok");
    const st = pulseState(td.querySelector("input").value);
    if (st) td.classList.add("field-"+st);
  });
}

function calcPatientStats(){
  const data = loadDiary();
  let ms=[], md=[], es=[], ed=[];
  let low=0, high=0, pl=0, ph=0;

  data.forEach(r=>{
    const mb=parseBP(r.mbp), eb=parseBP(r.ebp);
    if(mb){ms.push(mb.sys);md.push(mb.dia); if(bpState(r.mbp)==="low")low++; if(bpState(r.mbp)==="high")high++}
    if(eb){es.push(eb.sys);ed.push(eb.dia); if(bpState(r.ebp)==="low")low++; if(bpState(r.ebp)==="high")high++}
    if(pulseState(r.mhr)==="low")pl++;
    if(pulseState(r.ehr)==="low")pl++;
    if(pulseState(r.mhr)==="high")ph++;
    if(pulseState(r.ehr)==="high")ph++;
  });

  document.getElementById("p_avg_m").textContent = ms.length?`${Math.round(ms.reduce((a,b)=>a+b)/ms.length)}/${Math.round(md.reduce((a,b)=>a+b)/md.length)}`:"—";
  document.getElementById("p_avg_e").textContent = es.length?`${Math.round(es.reduce((a,b)=>a+b)/es.length)}/${Math.round(ed.reduce((a,b)=>a+b)/ed.length)}`:"—";
  document.getElementById("p_events").textContent = `${low} / ${high}`;
  document.getElementById("p_pulse_events").textContent = `Пульс: <50 — ${pl}, >100 — ${ph}`;
}

/* =========================
   CSV ЭКСПОРТ / ИМПОРТ
========================= */

document.getElementById("exportCsv").onclick = ()=>{
  const rows=[["День","Дата","Утро АД","Утро пульс","Вечер АД","Вечер пульс","Комментарий"]];
  loadDiary().forEach((r,i)=>rows.push([i+1,r.date,r.mbp,r.mhr,r.ebp,r.ehr,r.note]));
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(";")).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="bp-diary.csv"; a.click();
};

document.getElementById("csvFile").onchange = e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>processDoctorCSV(r.result);
  r.readAsText(f,"utf-8");
};

document.getElementById("btnClearImport").onclick=()=>{
  document.getElementById("csvFile").value="";
};

/* =========================
   СТАТИСТИКА ВРАЧА + ГРАФИК
========================= */

let doctorData=[];

function processDoctorCSV(text){
  const lines=text.split(/\r?\n/).slice(1);
  doctorData=[];
  lines.forEach(l=>{
    const c=l.split(";");
    if(c.length<6) return;
    doctorData.push({
      date:c[1], mbp:c[2], ebp:c[4]
    });
  });
  calcDoctorStats();
}

function calcDoctorStats(){
  let sys=[], dia=[], high=0, low=0;
  doctorData.forEach(r=>{
    [r.mbp,r.ebp].forEach(bp=>{
      const v=parseBP(bp);
      if(!v) return;
      sys.push(v.sys); dia.push(v.dia);
      if(bpState(bp)==="high")high++;
      if(bpState(bp)==="low")low++;
    });
  });

  document.getElementById("d_avg_all").textContent =
    sys.length?`${Math.round(sys.reduce((a,b)=>a+b)/sys.length)}/${Math.round(dia.reduce((a,b)=>a+b)/dia.length)}`:"—";

  document.getElementById("d_minmax").textContent =
    sys.length?`${Math.min(...sys)}/${Math.min(...dia)} – ${Math.max(...sys)}/${Math.max(...dia)}`:"—";

  document.getElementById("d_median").textContent =
    sys.length?`${Math.round(median(sys))}/${Math.round(median(dia))}`:"—";

  document.getElementById("d_range").textContent =
    sys.length?`${Math.max(...sys)-Math.min(...sys)}/${Math.max(...dia)-Math.min(...dia)}`:"—";

  document.getElementById("d_percent_high").textContent =
    sys.length?`${Math.round(high*100/sys.length)} %`:"—";

  document.getElementById("d_soft_flags").textContent =
    `низкое АД: ${low}, превышение: ${high}`;
}

/* =========================
   ГРАФИК
========================= */

const chartBtn=document.getElementById("toggleChart");
const chartBlock=document.getElementById("chartBlock");
chartBtn.onclick=()=>{
  chartBlock.hidden=!chartBlock.hidden;
  chartBtn.textContent=chartBlock.hidden?"Показать график":"Скрыть график";
  if(!chartBlock.hidden) drawChart();
};

function drawChart(){
  const c=document.getElementById("bpChart");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  if(!doctorData.length) return;

  const pts=[];
  doctorData.forEach((r,i)=>{
    const v=parseBP(r.mbp);
    if(v) pts.push({x:i,y:v.sys});
  });
  const max=Math.max(...pts.map(p=>p.y)), min=Math.min(...pts.map(p=>p.y));
  ctx.strokeStyle="#3a8f6a"; ctx.beginPath();
  pts.forEach((p,i)=>{
    const x=40+i*(c.width-60)/(pts.length-1);
    const y=c.height-20-(p.y-min)*(c.height-40)/(max-min||1);
    if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

</script>
</body>
</html>
