<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GB-monitoring — мониторинг гипертонической болезни</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a2e; --text:#e7eefc; --muted:#aab8d6;
      --line:#223052; --btn:#1a2b52; --btn2:#1f3b7a; --ok:#1f8f5f;
      --warn:#b86b1a; --danger:#b33a3a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(120deg,#070b14,#0b1220 55%,#070b14);color:var(--text)}
    a{color:#9fc2ff}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;gap:16px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;flex-direction:column;gap:6px}
    .brand h1{margin:0;font-size:20px;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);font-size:13px;max-width:820px;line-height:1.35}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line); background:var(--btn); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600;
      transition:transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none
    }
    .btn:hover{background:var(--btn2)}
    .btn:active{transform:translateY(1px)}
    .btn.active{border-color:#4a73ff;background:#17306a}
    .btn.secondary{background:transparent}
    .badge{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(16,26,46,.72); border:1px solid var(--line); border-radius:18px;
      padding:14px 14px 12px; box-shadow:0 10px 28px rgba(0,0,0,.25)
    }
    .card h2{margin:0 0 8px;font-size:15px}
    .card p{margin:0 0 10px;color:var(--muted);font-size:13px;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .note{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px
    }
    .pill b{color:var(--text)}
    .warn{color:#ffd7a8}
    .ok{color:#b7ffd8}
    /* diary */
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:8px;vertical-align:top}
    th{font-size:12px;color:#cfe0ff;background:rgba(20,32,58,.7);text-align:left}
    td{font-size:12px}
    input,select,textarea{
      width:100%; padding:8px 10px; border-radius:12px; border:1px solid var(--line);
      background:rgba(7,11,20,.6); color:var(--text); outline:none
    }
    input::placeholder,textarea::placeholder{color:#7183aa}
    textarea{min-height:38px;resize:vertical}
    .table-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    @media (max-width: 700px){.kpi{grid-template-columns:1fr}}
    .kpi .card{padding:12px}
    .kpi .val{font-size:18px;font-weight:800;margin-top:4px}
    .small{font-size:12px;color:var(--muted)}
    .footer{margin-top:16px;color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
  <div class="wrap">

    <header>
      <div class="brand">
        <h1>GB-monitoring</h1>
        <p>
          Продукт проекта: простой веб-инструмент для мониторинга гипертонической болезни.
          Режим <b>Пациент</b> — дневник самоконтроля и памятка. Режим <b>Врач</b> — контроль соблюдения, оценка данных и быстрые подсказки по дальнейшим шагам.
        </p>
        <div class="row">
          <span class="pill">Текущий режим: <b id="modeLabel">—</b></span>
          <span class="badge">Локально, без серверов (данные хранятся в браузере)</span>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn active" id="modeDoctor" type="button" aria-pressed="true">Режим: Врач</button>
        <button class="btn" id="modePatient" type="button" aria-pressed="false">Режим: Пациент</button>
        <button class="btn secondary" id="btnReset" type="button" title="Сбросить локальные данные дневника">Сброс данных</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <h2>Дневник артериального давления (30 дней)</h2>
        <p>
          Заполняйте утром и вечером. Кнопки ниже позволяют скачать заполненный дневник (CSV) или открыть печатные шаблоны (PDF/XLSX).
        </p>

        <div class="row">
          <button class="btn" id="toggleDiary" type="button">Показать дневник</button>

          <!-- Эти ссылки заработают после того, как вы добавите файлы в репозиторий (см. инструкцию ниже) -->
          <a class="btn" style="text-decoration:none;display:inline-block"
             id="downloadPdfLink" href="assets/bp-diary-30days.pdf" download>Скачать PDF (30 дней)</a>
          <a class="btn" style="text-decoration:none;display:inline-block"
             id="downloadXlsxLink" href="assets/bp-diary-30days.xlsx" download>Скачать XLSX (30 дней)</a>
        </div>

        <div id="bpDiary" hidden style="margin-top:12px">
          <div class="note">
            Формат ввода АД: <span class="mono">120/80</span>. Пульс — число. Поля сохраняются автоматически в браузере.
          </div>

          <div class="hr"></div>

          <table id="bpDiaryTable">
            <thead>
              <tr>
                <th style="width:54px">День</th>
                <th style="width:140px">Дата</th>
                <th style="width:130px">Утро АД</th>
                <th style="width:110px">Утро пульс</th>
                <th style="width:130px">Вечер АД</th>
                <th style="width:110px">Вечер пульс</th>
                <th>Самочувствие</th>
                <th>Комментарий</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="table-actions">
            <button class="btn" id="downloadDiaryCsv" type="button">Скачать заполненный дневник (CSV)</button>
            <button class="btn secondary" id="btnStats" type="button">Обновить сводку</button>
          </div>

          <div class="kpi" id="kpi" style="margin-top:10px">
            <div class="card">
              <div class="small">Среднее утро (САД/ДАД)</div>
              <div class="val" id="avgMorning">—</div>
              <div class="small" id="avgMorningNote"></div>
            </div>
            <div class="card">
              <div class="small">Среднее вечер (САД/ДАД)</div>
              <div class="val" id="avgEvening">—</div>
              <div class="small" id="avgEveningNote"></div>
            </div>
            <div class="card">
              <div class="small">Дней с повышением (ориентир)</div>
              <div class="val" id="highDays">—</div>
              <div class="small">Порог: ≥140/90 хотя бы в одном измерении</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="note warn">
            Важно: инструмент не заменяет клиническое решение. При симптомах поражения органов-мишеней (боль в груди, неврологический дефицит, выраженная одышка и т.п.) — действовать по неотложным алгоритмам.
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <h2>Контент по режимам</h2>
        <p>Эти блоки реально переключаются. Отметьте, что должно быть видно пациенту, а что — врачу.</p>

        <div class="hr"></div>

        <section data-role="patient">
          <h2>Пациент</h2>
          <p>
            Цель: регулярный самоконтроль и фиксация показателей. Измеряйте АД после 5 минут покоя, на одной и той же руке,
            манжета по размеру, без кофе/курения за 30 минут до измерения.
          </p>
          <ul style="margin:0;padding-left:18px;color:var(--muted);font-size:13px;line-height:1.5">
            <li>Записывайте утреннее и вечернее АД + пульс.</li>
            <li>Отмечайте самочувствие и возможные триггеры (стресс, недосып, солёная еда).</li>
            <li>Не меняйте терапию самостоятельно; решение — совместно с врачом.</li>
          </ul>
        </section>

        <section data-role="doctor">
          <h2>Врач</h2>
          <p>
            Быстрый просмотр дневника: ориентируйтесь на средние значения, вариабельность, частоту превышений порога,
            приверженность и симптомы. При необходимости — корректировка терапии, дообследование, оценка вторичных причин.
          </p>
          <ul style="margin:0;padding-left:18px;color:var(--muted);font-size:13px;line-height:1.5">
            <li>Контроль техники измерения и условия (избегать псевдогипертензии).</li>
            <li>Оценка “белого халата” / маскированной АГ по данным дневника.</li>
            <li>Согласовать цели АД с риском и коморбидностью; фиксировать изменения терапии.</li>
          </ul>
        </section>

        <div class="hr"></div>

        <div class="note">
          Подсказка: если PDF/XLSX не скачиваются — значит в репозитории нет файлов по путям
          <span class="mono">assets/bp-diary-30days.pdf</span> и <span class="mono">assets/bp-diary-30days.xlsx</span>.
        </div>
      </aside>
    </div>

    <div class="footer">
      <div>Версия: <span class="mono">index.html (single-file)</span>. Хостинг: GitHub Pages.</div>
    </div>

  </div>

  <script>
  (function () {
    // -----------------------
    // Mode switch (Doctor/Patient)
    // -----------------------
    const KEY_MODE = "gb_mode";
    const modeLabel = document.getElementById("modeLabel");
    const btnD = document.getElementById("modeDoctor");
    const btnP = document.getElementById("modePatient");

    function applyMode(mode) {
      const isDoctor = mode === "doctor";
      document.querySelectorAll("[data-role='doctor']").forEach(el => el.hidden = !isDoctor);
      document.querySelectorAll("[data-role='patient']").forEach(el => el.hidden = isDoctor);

      btnD?.classList.toggle("active", isDoctor);
      btnP?.classList.toggle("active", !isDoctor);
      btnD?.setAttribute("aria-pressed", String(isDoctor));
      btnP?.setAttribute("aria-pressed", String(!isDoctor));
      if (modeLabel) modeLabel.textContent = isDoctor ? "Врач" : "Пациент";

      localStorage.setItem(KEY_MODE, mode);
    }

    btnD?.addEventListener("click", () => applyMode("doctor"));
    btnP?.addEventListener("click", () => applyMode("patient"));

    const savedMode = localStorage.getItem(KEY_MODE);
    applyMode(savedMode === "patient" ? "patient" : "doctor");

    // -----------------------
    // Diary (30 days) + persistence
    // -----------------------
    const KEY_DIARY = "gb_bp_diary_v1";
    const wrap = document.getElementById("bpDiary");
    const btnToggle = document.getElementById("toggleDiary");
    const tbody = document.querySelector("#bpDiaryTable tbody");
    const btnCsv = document.getElementById("downloadDiaryCsv");
    const btnReset = document.getElementById("btnReset");
    const btnStats = document.getElementById("btnStats");

    function loadDiary() {
      try {
        return JSON.parse(localStorage.getItem(KEY_DIARY) || "[]");
      } catch {
        return [];
      }
    }

    function saveDiary(data) {
      localStorage.setItem(KEY_DIARY, JSON.stringify(data));
    }

    function ensureDiarySize(data, n) {
      const out = Array.isArray(data) ? data.slice(0, n) : [];
      while (out.length < n) {
        out.push({ date:"", m_bp:"", m_hr:"", e_bp:"", e_hr:"", feel:"", note:"" });
      }
      return out;
    }

    function buildDiary() {
      if (!tbody) return;

      const stored = ensureDiarySize(loadDiary(), 30);
      tbody.innerHTML = "";

      for (let i = 0; i < 30; i++) {
        const row = stored[i];
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td><input type="date" data-k="date" value="${escapeHtml(row.date)}"></td>
          <td><input placeholder="120/80" data-k="m_bp" value="${escapeHtml(row.m_bp)}"></td>
          <td><input placeholder="70" data-k="m_hr" value="${escapeHtml(row.m_hr)}"></td>
          <td><input placeholder="120/80" data-k="e_bp" value="${escapeHtml(row.e_bp)}"></td>
          <td><input placeholder="70" data-k="e_hr" value="${escapeHtml(row.e_hr)}"></td>
          <td><input placeholder="самочувствие" data-k="feel" value="${escapeHtml(row.feel)}"></td>
          <td><input placeholder="комментарий" data-k="note" value="${escapeHtml(row.note)}"></td>
        `;
        tbody.appendChild(tr);
      }

      // Save on input
      tbody.querySelectorAll("input").forEach(inp => {
        inp.addEventListener("input", () => {
          const data = readFromTable();
          saveDiary(data);
        });
      });

      saveDiary(stored);
      updateStats();
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function readFromTable() {
      const data = [];
      if (!tbody) return data;
      [...tbody.querySelectorAll("tr")].forEach(tr => {
        const obj = { date:"", m_bp:"", m_hr:"", e_bp:"", e_hr:"", feel:"", note:"" };
        tr.querySelectorAll("input[data-k]").forEach(inp => {
          obj[inp.getAttribute("data-k")] = inp.value.trim();
        });
        data.push(obj);
      });
      return data;
    }

    function parseBP(bp) {
      // "120/80" -> {sys:120,dia:80} else null
      const m = String(bp || "").trim().match(/^(\d{2,3})\s*\/\s*(\d{2,3})$/);
      if (!m) return null;
      const sys = Number(m[1]), dia = Number(m[2]);
      if (!Number.isFinite(sys) || !Number.isFinite(dia)) return null;
      return { sys, dia };
    }

    function updateStats() {
      const data = ensureDiarySize(loadDiary(), 30);

      let ms=0, md=0, mc=0;
      let es=0, ed=0, ec=0;
      let high=0;

      for (const r of data) {
        const mb = parseBP(r.m_bp);
        const eb = parseBP(r.e_bp);

        if (mb){ ms += mb.sys; md += mb.dia; mc++; if (mb.sys >= 140 || mb.dia >= 90) high++; }
        if (eb){ es += eb.sys; ed += eb.dia; ec++; if (eb.sys >= 140 || eb.dia >= 90) high++; }
      }

      const avgMorning = document.getElementById("avgMorning");
      const avgEvening = document.getElementById("avgEvening");
      const highDays = document.getElementById("highDays");
      const avgMorningNote = document.getElementById("avgMorningNote");
      const avgEveningNote = document.getElementById("avgEveningNote");

      if (avgMorning) avgMorning.textContent = mc ? `${Math.round(ms/mc)}/${Math.round(md/mc)}` : "—";
      if (avgEvening) avgEvening.textContent = ec ? `${Math.round(es/ec)}/${Math.round(ed/ec)}` : "—";
      if (highDays) highDays.textContent = String(high);

      if (avgMorningNote) avgMorningNote.textContent = mc ? `учтено измерений: ${mc}` : "нет данных";
      if (avgEveningNote) avgEveningNote.textContent = ec ? `учтено измерений: ${ec}` : "нет данных";
    }

    btnToggle?.addEventListener("click", () => {
      if (!wrap) return;
      wrap.hidden = !wrap.hidden;
      btnToggle.textContent = wrap.hidden ? "Показать дневник" : "Скрыть дневник";
      if (!wrap.hidden && (!tbody || tbody.children.length === 0)) buildDiary();
    });

    btnStats?.addEventListener("click", updateStats);

    btnCsv?.addEventListener("click", () => {
      const rows = [];
      rows.push(["День","Дата","Утро АД","Утро пульс","Вечер АД","Вечер пульс","Самочувствие","Комментарий"]);
      const data = ensureDiarySize(loadDiary(), 30);
      data.forEach((r, i) => {
        rows.push([String(i+1), r.date, r.m_bp, r.m_hr, r.e_bp, r.e_hr, r.feel, r.note]);
      });

      const csv = rows
        .map(r => r.map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(";"))
        .join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "bp-diary-30days.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    btnReset?.addEventListener("click", () => {
      if (!confirm("Сбросить сохранённые локально данные дневника?")) return;
      localStorage.removeItem(KEY_DIARY);
      if (tbody) tbody.innerHTML = "";
      if (wrap && !wrap.hidden) buildDiary();
      updateStats();
    });

    // Prebuild stats silently (does not require table render)
    updateStats();
  })();
  </script>
</body>
</html>
